(function(a){a.fn.eabi_telia_mtasku_payment_form=function(d){var f=null;var h="eabi_telia_mtasku";if(typeof d==="string"){d={qrTagUrl:d}}d=a.extend({},{imageSrc:null,qrTagUrl:null,apiCheckUrl:null,qrCodeLocation:"[data-role=qr-code]",cancelButtonLocation:"[data-role=cancel-button]",errorMessageLocation:"[data-role=error-message]",confirmButtonLocation:"[data-role=submit-form]",startButtonLocation:"[data-role=start-button]",errorMessageLocationIsGlobal:false,confirmButtonLocationIsGlobal:false,errorMessageHolderHtml:'<ul class="woocommerce-error" role="alert"></ul>',errorMessageElementHtml:"<li></li>",cancelText:"Cancel",startPaymentText:"Open mTasku app",allowRedirect:false},d);function i(j){if(f){clearTimeout(f);f=null}jQuery(j).closest(".form-block").remove()}function e(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}function b(l,k){var j=a(d.errorMessageHolderHtml);if(Array.isArray(k)){a.each(k,function(m,n){var o=a(d.errorMessageElementHtml).text(n);j.append(o)})}else{a.each([k],function(m,n){var o=a(d.errorMessageElementHtml).text(n);j.append(o)})}if(d.errorMessageLocationIsGlobal){jQuery(d.errorMessageLocation).html(j)}else{jQuery(l).find(d.errorMessageLocation).html(j)}}function c(j){if(d.apiCheckUrl){jQuery.ajax({url:d.apiCheckUrl,type:"post",dataType:"json",success:function(k){if(k.status=="complete"){j.resolve(k)}else{if(k.status=="waiting"){}else{if(k.status=="error"){j.reject(k)}}}},error:function(k){j.reject({status:"error"})},complete:function(k){if(f){clearTimeout(f)}f=setTimeout(function(){c(j)},1000)}})}}var g=function(n,o){var l={ecLevel:"H",size:230,text:n.qrTagUrl};var m=a.Deferred();var k=a.Deferred();var j=null;if(n.imageSrc){a("<img />").attr("src",n.imageSrc).on("load",function(){if(this){l=a.extend(l,{image:this,mode:4,mSize:0.2})}m.resolve(l)})}else{m.resolve(l)}a.when(k.promise()).then(function(p){if(p.status=="complete"){i(o);if(d.confirmButtonLocation){if(d.confirmButtonLocationIsGlobal){jQuery(d.confirmButtonLocation).click()}else{a(o).find(d.confirmButtonLocation).click()}}if(d.allowRedirect&&p.redirect){window.location.href=p.redirect}}else{if(p.status=="error"){i(o);b(o,d.genericErrorText)}else{if(p.status=="waiting"){}}}},function(p){i(o);b(o,d.genericErrorText)},function(p){});a.when(m.promise()).then(function(p){a(o).find(d.qrCodeLocation).qrcode(p);a(o).find(d.cancelButtonLocation).text(d.cancelText);a(o).find(d.startButtonLocation).text(d.startPaymentText);a(o).find(d.qrCodeLocation).on("click",function(){window.location.href=p.text});a(o).find(d.startButtonLocation).on("click",function(){window.location.href=p.text});a(o).find(d.cancelButtonLocation).on("click",function(){b(o,d.cancelErrorText);i(o)});if(e()){a(o).find(d.startButtonLocation).removeClass("not-visible")}f=setTimeout(function(){c(k)},1000)},function(p){i(o);b(o,d.genericErrorText)},function(p){});return j};return this.each(function(j,k){var l;if(!a(k).data(h)){l=g(d,k);a(k).data(h,true)}return l})}})(jQuery);